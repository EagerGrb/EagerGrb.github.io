"use strict";(self.webpackChunkrobin_note_book=self.webpackChunkrobin_note_book||[]).push([[5455],{5057:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>s});const l=JSON.parse('{"id":"L-\u6e90\u7801\u7cfb\u5217/closure-implementation","title":"\u95ed\u5305\u7684\u5e95\u5c42\u5b9e\u73b0\u673a\u5236\u6df1\u5ea6\u5206\u6790","description":"\u6982\u8ff0","source":"@site/docs/L-\u6e90\u7801\u7cfb\u5217/13-closure-implementation.md","sourceDirName":"L-\u6e90\u7801\u7cfb\u5217","slug":"/L-\u6e90\u7801\u7cfb\u5217/closure-implementation","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/closure-implementation","draft":false,"unlisted":false,"editUrl":"https://github.com/EagerGrb/docs/L-\u6e90\u7801\u7cfb\u5217/13-closure-implementation.md","tags":[],"version":"current","sidebarPosition":13,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Map\u3001Set\u3001Object\u5e95\u5c42\u5b9e\u73b0\u4e0e\u6027\u80fd\u5206\u6790","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/map-set-object-implementation"},"next":{"title":"\u8bcd\u6cd5\u4f5c\u7528\u57df\u4e0e\u53d8\u91cf\u4f5c\u7528\u57df\u6df1\u5ea6\u5206\u6790","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/lexical-scope-analysis"}}');var r=t(4848),c=t(8453);const i={},a="\u95ed\u5305\u7684\u5e95\u5c42\u5b9e\u73b0\u673a\u5236\u6df1\u5ea6\u5206\u6790",o={},s=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"1. \u95ed\u5305\u7684\u57fa\u672c\u6982\u5ff5",id:"1-\u95ed\u5305\u7684\u57fa\u672c\u6982\u5ff5",level:2},{value:"\u4ec0\u4e48\u6784\u6210\u95ed\u5305",id:"\u4ec0\u4e48\u6784\u6210\u95ed\u5305",level:3},{value:"V8\u4e2d\u95ed\u5305\u7684\u5224\u5b9a",id:"v8\u4e2d\u95ed\u5305\u7684\u5224\u5b9a",level:3},{value:"2. \u4f5c\u7528\u57df\u94fe\u548c\u4e0a\u4e0b\u6587",id:"2-\u4f5c\u7528\u57df\u94fe\u548c\u4e0a\u4e0b\u6587",level:2},{value:"\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",id:"\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",level:3},{value:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u521b\u5efa",id:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u521b\u5efa",level:3},{value:"3. \u53d8\u91cf\u6355\u83b7\u673a\u5236",id:"3-\u53d8\u91cf\u6355\u83b7\u673a\u5236",level:2},{value:"\u53d8\u91cf\u5206\u914d\u7b56\u7565",id:"\u53d8\u91cf\u5206\u914d\u7b56\u7565",level:3},{value:"\u95ed\u5305\u53d8\u91cf\u7684\u8bc6\u522b",id:"\u95ed\u5305\u53d8\u91cf\u7684\u8bc6\u522b",level:3},{value:"4. \u51fd\u6570\u5bf9\u8c61\u548c\u95ed\u5305",id:"4-\u51fd\u6570\u5bf9\u8c61\u548c\u95ed\u5305",level:2},{value:"JSFunction\u7684\u7ed3\u6784",id:"jsfunction\u7684\u7ed3\u6784",level:3},{value:"\u95ed\u5305\u7684\u521b\u5efa\u8fc7\u7a0b",id:"\u95ed\u5305\u7684\u521b\u5efa\u8fc7\u7a0b",level:3},{value:"5. \u5b57\u8282\u7801\u5c42\u9762\u7684\u95ed\u5305\u5b9e\u73b0",id:"5-\u5b57\u8282\u7801\u5c42\u9762\u7684\u95ed\u5305\u5b9e\u73b0",level:2},{value:"\u95ed\u5305\u521b\u5efa\u7684\u5b57\u8282\u7801",id:"\u95ed\u5305\u521b\u5efa\u7684\u5b57\u8282\u7801",level:3},{value:"\u4e0a\u4e0b\u6587\u64cd\u4f5c\u7684\u5b57\u8282\u7801\u6307\u4ee4",id:"\u4e0a\u4e0b\u6587\u64cd\u4f5c\u7684\u5b57\u8282\u7801\u6307\u4ee4",level:3},{value:"6. \u95ed\u5305\u7684\u5185\u5b58\u7ba1\u7406",id:"6-\u95ed\u5305\u7684\u5185\u5b58\u7ba1\u7406",level:2},{value:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f",id:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f",level:3},{value:"\u5783\u573e\u56de\u6536\u548c\u95ed\u5305",id:"\u5783\u573e\u56de\u6536\u548c\u95ed\u5305",level:3},{value:"7. \u590d\u6742\u95ed\u5305\u573a\u666f",id:"7-\u590d\u6742\u95ed\u5305\u573a\u666f",level:2},{value:"\u5d4c\u5957\u95ed\u5305",id:"\u5d4c\u5957\u95ed\u5305",level:3},{value:"\u5faa\u73af\u4e2d\u7684\u95ed\u5305",id:"\u5faa\u73af\u4e2d\u7684\u95ed\u5305",level:3},{value:"8. \u95ed\u5305\u7684\u6027\u80fd\u4f18\u5316",id:"8-\u95ed\u5305\u7684\u6027\u80fd\u4f18\u5316",level:2},{value:"\u5185\u8054\u7f13\u5b58\u4f18\u5316",id:"\u5185\u8054\u7f13\u5b58\u4f18\u5316",level:3},{value:"TurboFan\u7684\u95ed\u5305\u4f18\u5316",id:"turbofan\u7684\u95ed\u5305\u4f18\u5316",level:3},{value:"\u9003\u9038\u5206\u6790",id:"\u9003\u9038\u5206\u6790",level:3},{value:"9. \u95ed\u5305\u7684\u8c03\u8bd5",id:"9-\u95ed\u5305\u7684\u8c03\u8bd5",level:2},{value:"\u8c03\u8bd5\u5de5\u5177",id:"\u8c03\u8bd5\u5de5\u5177",level:3},{value:"\u5185\u5b58\u5206\u6790",id:"\u5185\u5b58\u5206\u6790",level:3},{value:"10. \u95ed\u5305\u7684\u6700\u4f73\u5b9e\u8df5",id:"10-\u95ed\u5305\u7684\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u907f\u514d\u610f\u5916\u7684\u95ed\u5305",id:"\u907f\u514d\u610f\u5916\u7684\u95ed\u5305",level:3},{value:"\u53ca\u65f6\u6e05\u7406\u95ed\u5305\u5f15\u7528",id:"\u53ca\u65f6\u6e05\u7406\u95ed\u5305\u5f15\u7528",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,c.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u95ed\u5305\u7684\u5e95\u5c42\u5b9e\u73b0\u673a\u5236\u6df1\u5ea6\u5206\u6790",children:"\u95ed\u5305\u7684\u5e95\u5c42\u5b9e\u73b0\u673a\u5236\u6df1\u5ea6\u5206\u6790"})}),"\n",(0,r.jsx)(e.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,r.jsx)(e.p,{children:"\u95ed\u5305\u662fJavaScript\u7684\u6838\u5fc3\u7279\u6027\u4e4b\u4e00\uff0c\u5b83\u5141\u8bb8\u5185\u90e8\u51fd\u6570\u8bbf\u95ee\u5916\u90e8\u51fd\u6570\u7684\u53d8\u91cf\u3002\u5728V8\u5f15\u64ce\u4e2d\uff0c\u95ed\u5305\u901a\u8fc7\u590d\u6742\u7684\u4f5c\u7528\u57df\u94fe\u7ba1\u7406\u3001\u4e0a\u4e0b\u6587\u4fdd\u5b58\u548c\u53d8\u91cf\u6355\u83b7\u673a\u5236\u6765\u5b9e\u73b0\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"1-\u95ed\u5305\u7684\u57fa\u672c\u6982\u5ff5",children:"1. \u95ed\u5305\u7684\u57fa\u672c\u6982\u5ff5"}),"\n",(0,r.jsx)(e.h3,{id:"\u4ec0\u4e48\u6784\u6210\u95ed\u5305",children:"\u4ec0\u4e48\u6784\u6210\u95ed\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function outerFunction(x) {\n  // \u5916\u90e8\u51fd\u6570\u7684\u53d8\u91cf\n  let outerVariable = x;\n  \n  // \u5185\u90e8\u51fd\u6570 - \u5f62\u6210\u95ed\u5305\n  function innerFunction(y) {\n    return outerVariable + y; // \u8bbf\u95ee\u5916\u90e8\u53d8\u91cf\n  }\n  \n  return innerFunction;\n}\n\nconst closure = outerFunction(10);\nconsole.log(closure(5)); // 15 - \u5916\u90e8\u51fd\u6570\u5df2\u6267\u884c\u5b8c\u6bd5\uff0c\u4f46\u53d8\u91cf\u4ecd\u53ef\u8bbf\u95ee\n"})}),"\n",(0,r.jsx)(e.h3,{id:"v8\u4e2d\u95ed\u5305\u7684\u5224\u5b9a",children:"V8\u4e2d\u95ed\u5305\u7684\u5224\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/ast/scopes.h\nclass Scope {\n  // \u68c0\u67e5\u662f\u5426\u9700\u8981\u521b\u5efa\u95ed\u5305\n  bool NeedsContext() const {\n    // \u5982\u679c\u6709\u53d8\u91cf\u88ab\u5185\u90e8\u51fd\u6570\u5f15\u7528\uff0c\u9700\u8981\u521b\u5efa\u4e0a\u4e0b\u6587\n    return num_heap_slots() > 0;\n  }\n  \n  // \u53d8\u91cf\u662f\u5426\u9700\u8981\u5728\u5806\u4e0a\u5206\u914d\uff08\u88ab\u95ed\u5305\u6355\u83b7\uff09\n  bool MustAllocateInContext(Variable* var);\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"2-\u4f5c\u7528\u57df\u94fe\u548c\u4e0a\u4e0b\u6587",children:"2. \u4f5c\u7528\u57df\u94fe\u548c\u4e0a\u4e0b\u6587"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",children:"\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u4f4d\u7f6e"}),": ",(0,r.jsx)(e.code,{children:"src/ast/scopes.cc"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class Scope {\n  Scope* outer_scope_;  // \u5916\u5c42\u4f5c\u7528\u57df\u6307\u9488\n  VariableMap variables_; // \u5f53\u524d\u4f5c\u7528\u57df\u7684\u53d8\u91cf\n  \n  // \u4f5c\u7528\u57df\u94fe\u67e5\u627e\n  Variable* LookupLocal(const AstRawString* name) {\n    return variables_.Lookup(name);\n  }\n  \n  // \u9012\u5f52\u67e5\u627e\u53d8\u91cf\n  static Variable* Lookup(VariableProxy* proxy, Scope* scope, Scope* outer_scope_end);\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u521b\u5efa",children:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u521b\u5efa"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/objects/contexts.h\nclass Context : public FixedArray {\n  // \u4e0a\u4e0b\u6587\u7c7b\u578b\n  enum ContextType {\n    FUNCTION_CONTEXT,    // \u51fd\u6570\u4e0a\u4e0b\u6587\n    BLOCK_CONTEXT,       // \u5757\u7ea7\u4e0a\u4e0b\u6587\n    MODULE_CONTEXT,      // \u6a21\u5757\u4e0a\u4e0b\u6587\n    SCRIPT_CONTEXT       // \u811a\u672c\u4e0a\u4e0b\u6587\n  };\n  \n  // \u83b7\u53d6\u4e0a\u7ea7\u4e0a\u4e0b\u6587\n  Tagged<Context> previous() const;\n  \n  // \u83b7\u53d6\u53d8\u91cf\u503c\n  Tagged<Object> get(int index) const;\n  void set(int index, Tagged<Object> value);\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"3-\u53d8\u91cf\u6355\u83b7\u673a\u5236",children:"3. \u53d8\u91cf\u6355\u83b7\u673a\u5236"}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u5206\u914d\u7b56\u7565",children:"\u53d8\u91cf\u5206\u914d\u7b56\u7565"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/ast/scopes.cc\nbool Scope::MustAllocateInContext(Variable* var) {\n  // \u68c0\u67e5\u53d8\u91cf\u662f\u5426\u88ab\u5185\u90e8\u4f5c\u7528\u57df\u5f15\u7528\n  if (var->is_used()) {\n    // \u5982\u679c\u53d8\u91cf\u88ab\u5185\u90e8\u51fd\u6570\u4f7f\u7528\uff0c\u5fc5\u987b\u5206\u914d\u5230\u4e0a\u4e0b\u6587\u4e2d\n    if (inner_scope_calls_eval_ || \n        var->has_forced_context_allocation()) {\n      return true;\n    }\n  }\n  return false;\n}\n\nvoid Scope::AllocateHeapSlot(Variable* var) {\n  // \u5728\u5806\u4e0a\u5206\u914d\u53d8\u91cf\u69fd\u4f4d\n  var->AllocateTo(VariableLocation::CONTEXT, num_heap_slots_++);\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u95ed\u5305\u53d8\u91cf\u7684\u8bc6\u522b",children:"\u95ed\u5305\u53d8\u91cf\u7684\u8bc6\u522b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u5728\u89e3\u6790\u9636\u6bb5\u8bc6\u522b\u9700\u8981\u6355\u83b7\u7684\u53d8\u91cf\nvoid Parser::ResolveVariable(VariableProxy* proxy) {\n  Variable* var = scope()->LookupLocal(proxy->raw_name());\n  \n  if (var == nullptr) {\n    // \u5728\u5916\u5c42\u4f5c\u7528\u57df\u4e2d\u67e5\u627e\n    var = scope()->outer_scope()->LookupLocal(proxy->raw_name());\n    if (var != nullptr) {\n      // \u6807\u8bb0\u53d8\u91cf\u9700\u8981\u4e0a\u4e0b\u6587\u5206\u914d\n      var->ForceContextAllocation();\n    }\n  }\n  \n  proxy->BindTo(var);\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"4-\u51fd\u6570\u5bf9\u8c61\u548c\u95ed\u5305",children:"4. \u51fd\u6570\u5bf9\u8c61\u548c\u95ed\u5305"}),"\n",(0,r.jsx)(e.h3,{id:"jsfunction\u7684\u7ed3\u6784",children:"JSFunction\u7684\u7ed3\u6784"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/objects/js-function.h\nclass JSFunction : public JSFunctionOrBoundFunctionOrWrappedFunction {\n  // \u51fd\u6570\u7684\u4e0a\u4e0b\u6587\uff08\u95ed\u5305\u73af\u5883\uff09\n  DECL_ACCESSORS(context, Tagged<Context>)\n  \n  // \u5171\u4eab\u51fd\u6570\u4fe1\u606f\n  DECL_ACCESSORS(shared, Tagged<SharedFunctionInfo>)\n  \n  // \u53cd\u9988\u5411\u91cf\uff08\u7528\u4e8e\u4f18\u5316\uff09\n  DECL_ACCESSORS(feedback_vector, Tagged<FeedbackVector>)\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u95ed\u5305\u7684\u521b\u5efa\u8fc7\u7a0b",children:"\u95ed\u5305\u7684\u521b\u5efa\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/builtins/builtins-function.cc\nBUILTIN(FastNewClosure) {\n  HandleScope scope(isolate);\n  \n  // \u83b7\u53d6\u5171\u4eab\u51fd\u6570\u4fe1\u606f\n  Handle<SharedFunctionInfo> shared_info = args.at<SharedFunctionInfo>(1);\n  Handle<Context> context = args.at<Context>(2);\n  \n  // \u521b\u5efa\u51fd\u6570\u5bf9\u8c61\n  Handle<JSFunction> function = \n      Factory::JSFunctionBuilder{isolate, shared_info, context}.Build();\n      \n  return *function;\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"5-\u5b57\u8282\u7801\u5c42\u9762\u7684\u95ed\u5305\u5b9e\u73b0",children:"5. \u5b57\u8282\u7801\u5c42\u9762\u7684\u95ed\u5305\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h3,{id:"\u95ed\u5305\u521b\u5efa\u7684\u5b57\u8282\u7801",children:"\u95ed\u5305\u521b\u5efa\u7684\u5b57\u8282\u7801"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function createClosure() {\n  let captured = "I\'m captured";\n  \n  return function() {\n    return captured;\n  };\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u7684\u5b57\u8282\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"// createClosure\u51fd\u6570\u7684\u5b57\u8282\u7801\nCreateFunctionContext [1]     // \u521b\u5efa\u51fd\u6570\u4e0a\u4e0b\u6587\uff0c1\u4e2a\u69fd\u4f4d\nPushContext r0               // \u4fdd\u5b58\u5f53\u524d\u4e0a\u4e0b\u6587\nLdaConstant [0]              // \u52a0\u8f7d\u5b57\u7b26\u4e32\u5e38\u91cf\nStaCurrentContextSlot [0]    // \u5b58\u50a8\u5230\u4e0a\u4e0b\u6587\u69fd\u4f4d0\n\n// \u521b\u5efa\u5185\u90e8\u51fd\u6570\uff08\u95ed\u5305\uff09\nCreateClosure [1], [2]       // \u521b\u5efa\u95ed\u5305\uff0c\u4f7f\u7528\u5f53\u524d\u4e0a\u4e0b\u6587\nPopContext r0                // \u6062\u590d\u4e0a\u4e0b\u6587\nReturn                       // \u8fd4\u56de\u95ed\u5305\n\n// \u5185\u90e8\u51fd\u6570\u7684\u5b57\u8282\u7801\nLdaCurrentContextSlot [0]    // \u4ece\u4e0a\u4e0b\u6587\u69fd\u4f4d0\u52a0\u8f7dcaptured\u53d8\u91cf\nReturn                       // \u8fd4\u56de\u503c\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u4e0a\u4e0b\u6587\u64cd\u4f5c\u7684\u5b57\u8282\u7801\u6307\u4ee4",children:"\u4e0a\u4e0b\u6587\u64cd\u4f5c\u7684\u5b57\u8282\u7801\u6307\u4ee4"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/interpreter/bytecodes.h\nenum class Bytecode : uint8_t {\n  // \u4e0a\u4e0b\u6587\u76f8\u5173\u64cd\u4f5c\n  kCreateFunctionContext,      // \u521b\u5efa\u51fd\u6570\u4e0a\u4e0b\u6587\n  kCreateBlockContext,         // \u521b\u5efa\u5757\u7ea7\u4e0a\u4e0b\u6587\n  kPushContext,               // \u63a8\u5165\u4e0a\u4e0b\u6587\n  kPopContext,                // \u5f39\u51fa\u4e0a\u4e0b\u6587\n  kLdaCurrentContextSlot,     // \u4ece\u5f53\u524d\u4e0a\u4e0b\u6587\u52a0\u8f7d\n  kStaCurrentContextSlot,     // \u5b58\u50a8\u5230\u5f53\u524d\u4e0a\u4e0b\u6587\n  kLdaContextSlot,           // \u4ece\u6307\u5b9a\u4e0a\u4e0b\u6587\u52a0\u8f7d\n  kStaContextSlot,           // \u5b58\u50a8\u5230\u6307\u5b9a\u4e0a\u4e0b\u6587\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"6-\u95ed\u5305\u7684\u5185\u5b58\u7ba1\u7406",children:"6. \u95ed\u5305\u7684\u5185\u5b58\u7ba1\u7406"}),"\n",(0,r.jsx)(e.h3,{id:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f",children:"\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u4e0a\u4e0b\u6587\u5bf9\u8c61\u5728\u5806\u4e0a\u5206\u914d\nclass Context : public FixedArray {\n  // \u4e0a\u4e0b\u6587\u7684\u5927\u5c0f\u8ba1\u7b97\n  static int SizeFor(int length) {\n    return FixedArray::SizeFor(length);\n  }\n  \n  // \u6700\u5c0f\u4e0a\u4e0b\u6587\u5927\u5c0f\uff08\u5305\u542b\u57fa\u672c\u69fd\u4f4d\uff09\n  static const int MIN_CONTEXT_SLOTS = 2;\n  static const int MIN_CONTEXT_EXTENDED_SLOTS = 3;\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5783\u573e\u56de\u6536\u548c\u95ed\u5305",children:"\u5783\u573e\u56de\u6536\u548c\u95ed\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u5783\u573e\u56de\u6536\nclass Context::BodyDescriptor : public FixedBodyDescriptor<\n    Context::kHeaderSize,\n    Context::kHeaderSize + Context::MIN_CONTEXT_SLOTS * kTaggedSize,\n    Context::kSizeOffset> {};\n\n// \u95ed\u5305\u5f15\u7528\u7684\u53d8\u91cf\u4f1a\u963b\u6b62\u5783\u573e\u56de\u6536\nvoid MarkCompactCollector::MarkObject(Tagged<HeapObject> obj) {\n  if (IsContext(obj)) {\n    // \u6807\u8bb0\u4e0a\u4e0b\u6587\u4e2d\u7684\u6240\u6709\u53d8\u91cf\n    Context::cast(obj)->IterateBody(this);\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"7-\u590d\u6742\u95ed\u5305\u573a\u666f",children:"7. \u590d\u6742\u95ed\u5305\u573a\u666f"}),"\n",(0,r.jsx)(e.h3,{id:"\u5d4c\u5957\u95ed\u5305",children:"\u5d4c\u5957\u95ed\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function level1() {\n  let var1 = "level1";\n  \n  function level2() {\n    let var2 = "level2";\n    \n    function level3() {\n      // \u8bbf\u95ee\u591a\u5c42\u5916\u90e8\u53d8\u91cf\n      return var1 + var2;\n    }\n    \n    return level3;\n  }\n  \n  return level2;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5904\u7406\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u521b\u5efa\u591a\u5c42\u4e0a\u4e0b\u6587\u94fe\n// level1: Context1 -> null\n// level2: Context2 -> Context1  \n// level3: Context3 -> Context2\n\n// \u53d8\u91cf\u67e5\u627e\u6cbf\u7740\u4e0a\u4e0b\u6587\u94fe\u8fdb\u884c\nTagged<Object> Context::Lookup(Handle<String> name) {\n  Context* current = this;\n  while (current != nullptr) {\n    // \u5728\u5f53\u524d\u4e0a\u4e0b\u6587\u4e2d\u67e5\u627e\n    Object* value = current->get(name);\n    if (!value->IsTheHole()) {\n      return value;\n    }\n    // \u79fb\u52a8\u5230\u5916\u5c42\u4e0a\u4e0b\u6587\n    current = current->previous();\n  }\n  return TheHole();\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5faa\u73af\u4e2d\u7684\u95ed\u5305",children:"\u5faa\u73af\u4e2d\u7684\u95ed\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u7ecf\u5178\u7684\u5faa\u73af\u95ed\u5305\u95ee\u9898\nfunction createClosures() {\n  const closures = [];\n  \n  for (var i = 0; i < 3; i++) {\n    closures.push(function() {\n      return i; // \u6240\u6709\u95ed\u5305\u90fd\u5f15\u7528\u540c\u4e00\u4e2ai\n    });\n  }\n  \n  return closures;\n}\n\n// ES6\u89e3\u51b3\u65b9\u6848\nfunction createClosuresES6() {\n  const closures = [];\n  \n  for (let i = 0; i < 3; i++) { // let\u521b\u5efa\u5757\u7ea7\u4f5c\u7528\u57df\n    closures.push(function() {\n      return i; // \u6bcf\u4e2a\u95ed\u5305\u5f15\u7528\u4e0d\u540c\u7684i\n    });\n  }\n  \n  return closures;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5bf9let\u7684\u5904\u7406\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u6bcf\u6b21\u5faa\u73af\u8fed\u4ee3\u521b\u5efa\u65b0\u7684\u5757\u7ea7\u4e0a\u4e0b\u6587\nStatement* Parser::ParseForStatement() {\n  // \u4e3alet\u58f0\u660e\u521b\u5efa\u65b0\u7684\u5757\u7ea7\u4f5c\u7528\u57df\n  Scope* for_scope = NewScope(BLOCK_SCOPE);\n  BlockState block_state(&scope_, for_scope);\n  \n  // \u6bcf\u6b21\u8fed\u4ee3\u90fd\u4f1a\u521b\u5efa\u65b0\u7684\u4e0a\u4e0b\u6587\n  // \u786e\u4fdd\u6bcf\u4e2a\u95ed\u5305\u6355\u83b7\u4e0d\u540c\u7684\u53d8\u91cf\u5b9e\u4f8b\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"8-\u95ed\u5305\u7684\u6027\u80fd\u4f18\u5316",children:"8. \u95ed\u5305\u7684\u6027\u80fd\u4f18\u5316"}),"\n",(0,r.jsx)(e.h3,{id:"\u5185\u8054\u7f13\u5b58\u4f18\u5316",children:"\u5185\u8054\u7f13\u5b58\u4f18\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u95ed\u5305\u4e2d\u7684\u53d8\u91cf\u8bbf\u95ee\u53ef\u4ee5\u88ab\u4f18\u5316\nclass LoadIC : public IC {\n  // \u5bf9\u4e8e\u95ed\u5305\u53d8\u91cf\u7684\u8bbf\u95ee\uff0c\u53ef\u4ee5\u7f13\u5b58\u4e0a\u4e0b\u6587\u69fd\u4f4d\n  void UpdateCaches(LookupIterator* lookup) {\n    if (lookup->IsFound() && lookup->IsDataProperty()) {\n      // \u7f13\u5b58\u53d8\u91cf\u5728\u4e0a\u4e0b\u6587\u4e2d\u7684\u4f4d\u7f6e\n      CacheContextSlotAccess(lookup);\n    }\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"turbofan\u7684\u95ed\u5305\u4f18\u5316",children:"TurboFan\u7684\u95ed\u5305\u4f18\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u7f16\u8bd1\u5668\u53ef\u4ee5\u4f18\u5316\u95ed\u5305\u53d8\u91cf\u8bbf\u95ee\nclass JSContextSpecialization : public AdvancedReducer {\n  // \u5c06\u4e0a\u4e0b\u6587\u53d8\u91cf\u8bbf\u95ee\u8f6c\u6362\u4e3a\u76f4\u63a5\u5185\u5b58\u8bbf\u95ee\n  Reduction ReduceJSLoadContext(Node* node) {\n    // \u5982\u679c\u4e0a\u4e0b\u6587\u662f\u5e38\u91cf\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f18\u5316\u4e3a\u5e38\u91cf\u52a0\u8f7d\n    if (context_is_constant) {\n      return Replace(constant_value);\n    }\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u9003\u9038\u5206\u6790",children:"\u9003\u9038\u5206\u6790"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u5982\u679c\u95ed\u5305\u6ca1\u6709\u9003\u9038\uff0c\u53ef\u4ee5\u8fdb\u884c\u6808\u5206\u914d\u4f18\u5316\nclass EscapeAnalysis {\n  bool IsEscaping(Node* node) {\n    // \u68c0\u67e5\u95ed\u5305\u662f\u5426\u9003\u9038\u5230\u5916\u90e8\n    // \u5982\u679c\u6ca1\u6709\u9003\u9038\uff0c\u53ef\u4ee5\u5728\u6808\u4e0a\u5206\u914d\u53d8\u91cf\n    return node->opcode() == IrOpcode::kReturn ||\n           node->opcode() == IrOpcode::kStoreField;\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"9-\u95ed\u5305\u7684\u8c03\u8bd5",children:"9. \u95ed\u5305\u7684\u8c03\u8bd5"}),"\n",(0,r.jsx)(e.h3,{id:"\u8c03\u8bd5\u5de5\u5177",children:"\u8c03\u8bd5\u5de5\u5177"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'# \u67e5\u770b\u95ed\u5305\u7684\u5b57\u8282\u7801\nd8 --print-bytecode closure.js\n\n# \u67e5\u770b\u4e0a\u4e0b\u6587\u4fe1\u606f\nd8 --allow-natives-syntax -e "\nfunction outer() {\n  let x = 42;\n  return function() { return x; };\n}\nconst closure = outer();\n%DebugPrint(closure);\n"\n'})}),"\n",(0,r.jsx)(e.h3,{id:"\u5185\u5b58\u5206\u6790",children:"\u5185\u5b58\u5206\u6790"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u68c0\u67e5\u95ed\u5305\u662f\u5426\u9020\u6210\u5185\u5b58\u6cc4\u6f0f\nfunction createLeak() {\n  const largeData = new Array(1000000).fill('data');\n  \n  return function() {\n    // \u5373\u4f7f\u53ea\u4f7f\u7528\u4e00\u4e2a\u5c0f\u53d8\u91cf\uff0c\u6574\u4e2alargeData\u4e5f\u4f1a\u88ab\u4fdd\u7559\n    return largeData.length;\n  };\n}\n\n// \u4f18\u5316\u7248\u672c\nfunction createOptimized() {\n  const largeData = new Array(1000000).fill('data');\n  const length = largeData.length; // \u63d0\u53d6\u9700\u8981\u7684\u503c\n  \n  return function() {\n    return length; // \u53ea\u4fdd\u7559\u5fc5\u8981\u7684\u6570\u636e\n  };\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"10-\u95ed\u5305\u7684\u6700\u4f73\u5b9e\u8df5",children:"10. \u95ed\u5305\u7684\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(e.h3,{id:"\u907f\u514d\u610f\u5916\u7684\u95ed\u5305",children:"\u907f\u514d\u610f\u5916\u7684\u95ed\u5305"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u907f\u514d\u5728\u5faa\u73af\u4e2d\u521b\u5efa\u4e0d\u5fc5\u8981\u7684\u95ed\u5305\n// \u4e0d\u597d\u7684\u505a\u6cd5\nfunction attachListeners() {\n  const elements = document.querySelectorAll('.item');\n  \n  for (let i = 0; i < elements.length; i++) {\n    elements[i].addEventListener('click', function() {\n      // \u8fd9\u91cc\u521b\u5efa\u4e86\u4e0d\u5fc5\u8981\u7684\u95ed\u5305\n      console.log('Clicked item', i);\n    });\n  }\n}\n\n// \u66f4\u597d\u7684\u505a\u6cd5\nfunction attachListenersOptimized() {\n  const elements = document.querySelectorAll('.item');\n  \n  function handleClick(index) {\n    return function() {\n      console.log('Clicked item', index);\n    };\n  }\n  \n  for (let i = 0; i < elements.length; i++) {\n    elements[i].addEventListener('click', handleClick(i));\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u53ca\u65f6\u6e05\u7406\u95ed\u5305\u5f15\u7528",children:"\u53ca\u65f6\u6e05\u7406\u95ed\u5305\u5f15\u7528"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function createTimer() {\n  const data = new Array(1000000).fill('data');\n  \n  const timer = setInterval(function() {\n    // \u4f7f\u7528data\n    console.log(data.length);\n  }, 1000);\n  \n  // \u63d0\u4f9b\u6e05\u7406\u65b9\u6cd5\n  return {\n    clear: function() {\n      clearInterval(timer);\n      // \u663e\u5f0f\u6e05\u7406\u5f15\u7528\n      data = null;\n    }\n  };\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"\u95ed\u5305\u5728V8\u4e2d\u7684\u5b9e\u73b0\u6d89\u53ca\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u4f5c\u7528\u57df\u5206\u6790"}),": \u5728\u89e3\u6790\u9636\u6bb5\u8bc6\u522b\u9700\u8981\u6355\u83b7\u7684\u53d8\u91cf"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u4e0a\u4e0b\u6587\u521b\u5efa"}),": \u4e3a\u95ed\u5305\u521b\u5efa\u5806\u4e0a\u7684\u4e0a\u4e0b\u6587\u5bf9\u8c61"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u53d8\u91cf\u5206\u914d"}),": \u5c06\u6355\u83b7\u7684\u53d8\u91cf\u5206\u914d\u5230\u4e0a\u4e0b\u6587\u69fd\u4f4d"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u5b57\u8282\u7801\u751f\u6210"}),": \u751f\u6210\u4e0a\u4e0b\u6587\u64cd\u4f5c\u7684\u5b57\u8282\u7801\u6307\u4ee4"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u5185\u5b58\u7ba1\u7406"}),": \u901a\u8fc7\u5783\u573e\u56de\u6536\u7ba1\u7406\u4e0a\u4e0b\u6587\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u6027\u80fd\u4f18\u5316"}),": \u901a\u8fc7\u5185\u8054\u7f13\u5b58\u3001\u9003\u9038\u5206\u6790\u7b49\u6280\u672f\u4f18\u5316\u95ed\u5305\u6027\u80fd"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7406\u89e3\u8fd9\u4e9b\u5e95\u5c42\u673a\u5236\u6709\u52a9\u4e8e\u7f16\u5199\u66f4\u9ad8\u6548\u7684JavaScript\u4ee3\u7801\uff0c\u907f\u514d\u95ed\u5305\u76f8\u5173\u7684\u6027\u80fd\u95ee\u9898\u548c\u5185\u5b58\u6cc4\u6f0f\u3002"})]})}function u(n={}){const{wrapper:e}={...(0,c.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},8453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>a});var l=t(6540);const r={},c=l.createContext(r);function i(n){const e=l.useContext(c);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:i(n.components),l.createElement(c.Provider,{value:e},n.children)}}}]);