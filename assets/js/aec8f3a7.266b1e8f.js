"use strict";(self.webpackChunkrobin_note_book=self.webpackChunkrobin_note_book||[]).push([[2217],{2319:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>c,metadata:()=>i,toc:()=>t});const i=JSON.parse('{"id":"L-\u6e90\u7801\u7cfb\u5217/lexical-scope-analysis","title":"\u8bcd\u6cd5\u4f5c\u7528\u57df\u4e0e\u53d8\u91cf\u4f5c\u7528\u57df\u6df1\u5ea6\u5206\u6790","description":"\u6982\u8ff0","source":"@site/docs/L-\u6e90\u7801\u7cfb\u5217/14-lexical-scope-analysis.md","sourceDirName":"L-\u6e90\u7801\u7cfb\u5217","slug":"/L-\u6e90\u7801\u7cfb\u5217/lexical-scope-analysis","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/lexical-scope-analysis","draft":false,"unlisted":false,"editUrl":"https://github.com/EagerGrb/docs/L-\u6e90\u7801\u7cfb\u5217/14-lexical-scope-analysis.md","tags":[],"version":"current","sidebarPosition":14,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u95ed\u5305\u7684\u5e95\u5c42\u5b9e\u73b0\u673a\u5236\u6df1\u5ea6\u5206\u6790","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/closure-implementation"},"next":{"title":"V8 JavaScript\u5f15\u64ce\u6e90\u7801\u5b66\u4e60\u6307\u5357","permalink":"/docs/main/L-\u6e90\u7801\u7cfb\u5217/"}}');var r=l(4848),a=l(8453);const c={},o="\u8bcd\u6cd5\u4f5c\u7528\u57df\u4e0e\u53d8\u91cf\u4f5c\u7528\u57df\u6df1\u5ea6\u5206\u6790",s={},t=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"1. \u8bcd\u6cd5\u4f5c\u7528\u57df\u57fa\u7840",id:"1-\u8bcd\u6cd5\u4f5c\u7528\u57df\u57fa\u7840",level:2},{value:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u7684\u5b9a\u4e49",id:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u7684\u5b9a\u4e49",level:3},{value:"V8\u4e2d\u7684\u4f5c\u7528\u57df\u8868\u793a",id:"v8\u4e2d\u7684\u4f5c\u7528\u57df\u8868\u793a",level:3},{value:"2. \u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",id:"2-\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",level:2},{value:"\u89e3\u6790\u65f6\u7684\u4f5c\u7528\u57df\u521b\u5efa",id:"\u89e3\u6790\u65f6\u7684\u4f5c\u7528\u57df\u521b\u5efa",level:3},{value:"\u51fd\u6570\u4f5c\u7528\u57df\u7684\u521b\u5efa",id:"\u51fd\u6570\u4f5c\u7528\u57df\u7684\u521b\u5efa",level:3},{value:"3. \u53d8\u91cf\u58f0\u660e\u548c\u7ed1\u5b9a",id:"3-\u53d8\u91cf\u58f0\u660e\u548c\u7ed1\u5b9a",level:2},{value:"\u53d8\u91cf\u7c7b\u578b\u548c\u6a21\u5f0f",id:"\u53d8\u91cf\u7c7b\u578b\u548c\u6a21\u5f0f",level:3},{value:"\u53d8\u91cf\u58f0\u660e\u5904\u7406",id:"\u53d8\u91cf\u58f0\u660e\u5904\u7406",level:3},{value:"4. \u4e0d\u540c\u58f0\u660e\u65b9\u5f0f\u7684\u4f5c\u7528\u57df\u884c\u4e3a",id:"4-\u4e0d\u540c\u58f0\u660e\u65b9\u5f0f\u7684\u4f5c\u7528\u57df\u884c\u4e3a",level:2},{value:"var\u58f0\u660e - \u51fd\u6570\u4f5c\u7528\u57df",id:"var\u58f0\u660e---\u51fd\u6570\u4f5c\u7528\u57df",level:3},{value:"let/const\u58f0\u660e - \u5757\u7ea7\u4f5c\u7528\u57df",id:"letconst\u58f0\u660e---\u5757\u7ea7\u4f5c\u7528\u57df",level:3},{value:"\u51fd\u6570\u58f0\u660e\u7684\u4f5c\u7528\u57df",id:"\u51fd\u6570\u58f0\u660e\u7684\u4f5c\u7528\u57df",level:3},{value:"5. \u4f5c\u7528\u57df\u89e3\u6790\u8fc7\u7a0b",id:"5-\u4f5c\u7528\u57df\u89e3\u6790\u8fc7\u7a0b",level:2},{value:"\u53d8\u91cf\u89e3\u6790\u7b97\u6cd5",id:"\u53d8\u91cf\u89e3\u6790\u7b97\u6cd5",level:3},{value:"\u53d8\u91cf\u7ed1\u5b9a\u8fc7\u7a0b",id:"\u53d8\u91cf\u7ed1\u5b9a\u8fc7\u7a0b",level:3},{value:"6. \u7279\u6b8a\u4f5c\u7528\u57df\u60c5\u51b5",id:"6-\u7279\u6b8a\u4f5c\u7528\u57df\u60c5\u51b5",level:2},{value:"with\u8bed\u53e5\u7684\u52a8\u6001\u4f5c\u7528\u57df",id:"with\u8bed\u53e5\u7684\u52a8\u6001\u4f5c\u7528\u57df",level:3},{value:"eval\u7684\u4f5c\u7528\u57df\u5f71\u54cd",id:"eval\u7684\u4f5c\u7528\u57df\u5f71\u54cd",level:3},{value:"7. \u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801\u8868\u793a",id:"7-\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801\u8868\u793a",level:2},{value:"\u4e0a\u4e0b\u6587\u521b\u5efa\u5b57\u8282\u7801",id:"\u4e0a\u4e0b\u6587\u521b\u5efa\u5b57\u8282\u7801",level:3},{value:"\u5757\u7ea7\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801",id:"\u5757\u7ea7\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801",level:3},{value:"8. \u6682\u65f6\u6027\u6b7b\u533a(TDZ)\u5b9e\u73b0",id:"8-\u6682\u65f6\u6027\u6b7b\u533atdz\u5b9e\u73b0",level:2},{value:"TDZ\u7684\u68c0\u67e5\u673a\u5236",id:"tdz\u7684\u68c0\u67e5\u673a\u5236",level:3},{value:"TDZ\u68c0\u67e5\u7684\u5b57\u8282\u7801\u751f\u6210",id:"tdz\u68c0\u67e5\u7684\u5b57\u8282\u7801\u751f\u6210",level:3},{value:"TDZ\u793a\u4f8b",id:"tdz\u793a\u4f8b",level:3},{value:"9. \u4f5c\u7528\u57df\u4f18\u5316",id:"9-\u4f5c\u7528\u57df\u4f18\u5316",level:2},{value:"\u4f5c\u7528\u57df\u5206\u6790\u4f18\u5316",id:"\u4f5c\u7528\u57df\u5206\u6790\u4f18\u5316",level:3},{value:"\u7f16\u8bd1\u5668\u4f18\u5316",id:"\u7f16\u8bd1\u5668\u4f18\u5316",level:3},{value:"10. \u8c03\u8bd5\u4f5c\u7528\u57df",id:"10-\u8c03\u8bd5\u4f5c\u7528\u57df",level:2},{value:"\u8c03\u8bd5\u5de5\u5177",id:"\u8c03\u8bd5\u5de5\u5177",level:3},{value:"\u4f5c\u7528\u57df\u53ef\u89c6\u5316",id:"\u4f5c\u7528\u57df\u53ef\u89c6\u5316",level:3},{value:"11. \u5e38\u89c1\u4f5c\u7528\u57df\u9677\u9631",id:"11-\u5e38\u89c1\u4f5c\u7528\u57df\u9677\u9631",level:2},{value:"\u5faa\u73af\u4e2d\u7684\u4f5c\u7528\u57df\u95ee\u9898",id:"\u5faa\u73af\u4e2d\u7684\u4f5c\u7528\u57df\u95ee\u9898",level:3},{value:"\u610f\u5916\u7684\u5168\u5c40\u53d8\u91cf",id:"\u610f\u5916\u7684\u5168\u5c40\u53d8\u91cf",level:3},{value:"12. \u6700\u4f73\u5b9e\u8df5",id:"12-\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u4f5c\u7528\u57df\u7ba1\u7406\u5efa\u8bae",id:"\u4f5c\u7528\u57df\u7ba1\u7406\u5efa\u8bae",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u4e0e\u53d8\u91cf\u4f5c\u7528\u57df\u6df1\u5ea6\u5206\u6790",children:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u4e0e\u53d8\u91cf\u4f5c\u7528\u57df\u6df1\u5ea6\u5206\u6790"})}),"\n",(0,r.jsx)(e.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,r.jsx)(e.p,{children:"\u4f5c\u7528\u57df\u662fJavaScript\u4e2d\u6700\u91cd\u8981\u7684\u6982\u5ff5\u4e4b\u4e00\uff0c\u5b83\u51b3\u5b9a\u4e86\u53d8\u91cf\u7684\u53ef\u89c1\u6027\u548c\u751f\u547d\u5468\u671f\u3002V8\u5f15\u64ce\u901a\u8fc7\u590d\u6742\u7684\u4f5c\u7528\u57df\u7ba1\u7406\u7cfb\u7edf\u6765\u5b9e\u73b0JavaScript\u7684\u8bcd\u6cd5\u4f5c\u7528\u57df\u89c4\u5219\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"1-\u8bcd\u6cd5\u4f5c\u7528\u57df\u57fa\u7840",children:"1. \u8bcd\u6cd5\u4f5c\u7528\u57df\u57fa\u7840"}),"\n",(0,r.jsx)(e.h3,{id:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u7684\u5b9a\u4e49",children:"\u8bcd\u6cd5\u4f5c\u7528\u57df\u7684\u5b9a\u4e49"}),"\n",(0,r.jsx)(e.p,{children:"\u8bcd\u6cd5\u4f5c\u7528\u57df\uff08Lexical Scope\uff09\u4e5f\u79f0\u4e3a\u9759\u6001\u4f5c\u7528\u57df\uff0c\u662f\u6307\u53d8\u91cf\u7684\u4f5c\u7528\u57df\u5728\u4ee3\u7801\u7f16\u5199\u65f6\u5c31\u786e\u5b9a\u4e86\uff0c\u800c\u4e0d\u662f\u5728\u8fd0\u884c\u65f6\u786e\u5b9a\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function outer() {\n  let x = 10;\n  \n  function inner() {\n    console.log(x); // \u8bcd\u6cd5\u4f5c\u7528\u57df\uff1a\u8bbf\u95ee\u5916\u5c42\u7684x\n  }\n  \n  return inner;\n}\n\nconst fn = outer();\nfn(); // 10 - \u5373\u4f7fouter\u5df2\u6267\u884c\u5b8c\u6bd5\uff0cinner\u4ecd\u80fd\u8bbf\u95eex\n"})}),"\n",(0,r.jsx)(e.h3,{id:"v8\u4e2d\u7684\u4f5c\u7528\u57df\u8868\u793a",children:"V8\u4e2d\u7684\u4f5c\u7528\u57df\u8868\u793a"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u4f4d\u7f6e"}),": ",(0,r.jsx)(e.code,{children:"src/ast/scopes.h"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class Scope : public ZoneObject {\npublic:\n  // \u4f5c\u7528\u57df\u7c7b\u578b\u679a\u4e3e\n  enum ScopeType {\n    SCRIPT_SCOPE,      // \u811a\u672c\u4f5c\u7528\u57df\uff08\u5168\u5c40\uff09\n    FUNCTION_SCOPE,    // \u51fd\u6570\u4f5c\u7528\u57df\n    MODULE_SCOPE,      // \u6a21\u5757\u4f5c\u7528\u57df\n    EVAL_SCOPE,        // eval\u4f5c\u7528\u57df\n    BLOCK_SCOPE,       // \u5757\u7ea7\u4f5c\u7528\u57df\n    CATCH_SCOPE,       // catch\u5757\u4f5c\u7528\u57df\n    WITH_SCOPE         // with\u8bed\u53e5\u4f5c\u7528\u57df\n  };\n\nprivate:\n  Scope* outer_scope_;        // \u5916\u5c42\u4f5c\u7528\u57df\u6307\u9488\n  Scope* inner_scope_;        // \u5185\u5c42\u4f5c\u7528\u57df\u6307\u9488\n  Scope* sibling_;           // \u5144\u5f1f\u4f5c\u7528\u57df\u6307\u9488\n  VariableMap variables_;     // \u5f53\u524d\u4f5c\u7528\u57df\u7684\u53d8\u91cf\u6620\u5c04\n  ScopeType scope_type_;     // \u4f5c\u7528\u57df\u7c7b\u578b\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"2-\u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa",children:"2. \u4f5c\u7528\u57df\u94fe\u7684\u6784\u5efa"}),"\n",(0,r.jsx)(e.h3,{id:"\u89e3\u6790\u65f6\u7684\u4f5c\u7528\u57df\u521b\u5efa",children:"\u89e3\u6790\u65f6\u7684\u4f5c\u7528\u57df\u521b\u5efa"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/parsing/parser.cc\nclass Parser {\n  // \u5f53\u524d\u4f5c\u7528\u57df\u6307\u9488\n  Scope* scope_;\n  \n  // \u521b\u5efa\u65b0\u4f5c\u7528\u57df\n  Scope* NewScope(ScopeType scope_type) {\n    return zone()->New<Scope>(zone(), scope_, scope_type);\n  }\n  \n  // \u4f5c\u7528\u57df\u72b6\u6001\u7ba1\u7406\n  class BlockState {\n    BlockState(Scope** scope_stack, Scope* scope)\n        : scope_stack_(scope_stack), outer_scope_(*scope_stack) {\n      *scope_stack_ = scope;\n    }\n    \n    ~BlockState() {\n      *scope_stack_ = outer_scope_;\n    }\n  };\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u51fd\u6570\u4f5c\u7528\u57df\u7684\u521b\u5efa",children:"\u51fd\u6570\u4f5c\u7528\u57df\u7684\u521b\u5efa"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function example() {\n  let a = 1;        // \u51fd\u6570\u4f5c\u7528\u57df\u53d8\u91cf\n  \n  if (true) {\n    let b = 2;      // \u5757\u7ea7\u4f5c\u7528\u57df\u53d8\u91cf\n    \n    function nested() {\n      let c = 3;    // \u5d4c\u5957\u51fd\u6570\u4f5c\u7528\u57df\u53d8\u91cf\n      return a + b + c;\n    }\n    \n    return nested;\n  }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"V8\u7684\u4f5c\u7528\u57df\u6811\u7ed3\u6784\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"ScriptScope\n\u2514\u2500\u2500 FunctionScope(example)\n    \u251c\u2500\u2500 Variable(a)\n    \u2514\u2500\u2500 BlockScope(if)\n        \u251c\u2500\u2500 Variable(b)\n        \u2514\u2500\u2500 FunctionScope(nested)\n            \u2514\u2500\u2500 Variable(c)\n"})}),"\n",(0,r.jsx)(e.h2,{id:"3-\u53d8\u91cf\u58f0\u660e\u548c\u7ed1\u5b9a",children:"3. \u53d8\u91cf\u58f0\u660e\u548c\u7ed1\u5b9a"}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u7c7b\u578b\u548c\u6a21\u5f0f",children:"\u53d8\u91cf\u7c7b\u578b\u548c\u6a21\u5f0f"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// \u53d8\u91cf\u6a21\u5f0f\nenum class VariableMode : uint8_t {\n  kLet,           // let\u58f0\u660e\n  kConst,         // const\u58f0\u660e\n  kVar,           // var\u58f0\u660e\n  kTemporary,     // \u4e34\u65f6\u53d8\u91cf\n  kDynamic,       // \u52a8\u6001\u53d8\u91cf\uff08eval\u7b49\uff09\n  kUsing,         // using\u58f0\u660e\uff08\u63d0\u6848\uff09\n  kAwaitUsing     // await using\u58f0\u660e\uff08\u63d0\u6848\uff09\n};\n\n// \u53d8\u91cf\u79cd\u7c7b\nenum VariableKind {\n  NORMAL_VARIABLE,      // \u666e\u901a\u53d8\u91cf\n  PARAMETER_VARIABLE,   // \u53c2\u6570\u53d8\u91cf\n  ARGUMENTS_VARIABLE,   // arguments\u5bf9\u8c61\n  THIS_VARIABLE,        // this\u53d8\u91cf\n  SLOPPY_BLOCK_FUNCTION_VARIABLE  // \u677e\u6563\u6a21\u5f0f\u5757\u51fd\u6570\u53d8\u91cf\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u58f0\u660e\u5904\u7406",children:"\u53d8\u91cf\u58f0\u660e\u5904\u7406"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class Scope {\n  // \u58f0\u660e\u53d8\u91cf\n  Variable* DeclareVariable(Declaration* declaration,\n                           const AstRawString* name,\n                           int pos,\n                           VariableMode mode,\n                           VariableKind kind,\n                           InitializationFlag init,\n                           bool* was_added);\n                           \n  // \u67e5\u627e\u672c\u5730\u53d8\u91cf\n  Variable* LookupLocal(const AstRawString* name) {\n    return variables_.Lookup(name);\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"4-\u4e0d\u540c\u58f0\u660e\u65b9\u5f0f\u7684\u4f5c\u7528\u57df\u884c\u4e3a",children:"4. \u4e0d\u540c\u58f0\u660e\u65b9\u5f0f\u7684\u4f5c\u7528\u57df\u884c\u4e3a"}),"\n",(0,r.jsx)(e.h3,{id:"var\u58f0\u660e---\u51fd\u6570\u4f5c\u7528\u57df",children:"var\u58f0\u660e - \u51fd\u6570\u4f5c\u7528\u57df"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function varExample() {\n  console.log(x); // undefined\uff08\u63d0\u5347\uff09\n  \n  if (true) {\n    var x = 1;    // \u63d0\u5347\u5230\u51fd\u6570\u4f5c\u7528\u57df\u9876\u90e8\n  }\n  \n  console.log(x); // 1\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5904\u7406var\u58f0\u660e\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"Variable* Parser::DeclareVariable(const AstRawString* name, \n                                 VariableMode mode) {\n  if (mode == VariableMode::kVar) {\n    // var\u58f0\u660e\u603b\u662f\u5728\u51fd\u6570\u4f5c\u7528\u57df\u4e2d\u58f0\u660e\n    DeclarationScope* declaration_scope = GetDeclarationScope();\n    return declaration_scope->DeclareVariable(name, mode, kCreatedInitialized);\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"letconst\u58f0\u660e---\u5757\u7ea7\u4f5c\u7528\u57df",children:"let/const\u58f0\u660e - \u5757\u7ea7\u4f5c\u7528\u57df"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function letConstExample() {\n  // console.log(x); // ReferenceError: Cannot access 'x' before initialization\n  \n  if (true) {\n    let x = 1;      // \u5757\u7ea7\u4f5c\u7528\u57df\n    const y = 2;    // \u5757\u7ea7\u4f5c\u7528\u57df\n    console.log(x, y); // 1, 2\n  }\n  \n  // console.log(x); // ReferenceError: x is not defined\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5904\u7406let/const\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"Variable* Parser::DeclareVariable(const AstRawString* name,\n                                 VariableMode mode) {\n  if (mode == VariableMode::kLet || mode == VariableMode::kConst) {\n    // let/const\u5728\u5f53\u524d\u4f5c\u7528\u57df\u4e2d\u58f0\u660e\n    Variable* var = scope()->DeclareLocal(name, mode, kNeedsInitialization);\n    // \u8bbe\u7f6e\u521d\u59cb\u5316\u4f4d\u7f6e\u7528\u4e8eTDZ\u68c0\u67e5\n    var->set_initializer_position(scanner()->location().beg_pos);\n    return var;\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u51fd\u6570\u58f0\u660e\u7684\u4f5c\u7528\u57df",children:"\u51fd\u6570\u58f0\u660e\u7684\u4f5c\u7528\u57df"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function functionDeclExample() {\n  console.log(typeof foo); // "function"\uff08\u5b8c\u5168\u63d0\u5347\uff09\n  \n  if (true) {\n    function foo() {        // \u51fd\u6570\u58f0\u660e\n      return "foo";\n    }\n    \n    var bar = function() {  // \u51fd\u6570\u8868\u8fbe\u5f0f\n      return "bar";\n    };\n  }\n  \n  console.log(typeof foo); // "function"\n  console.log(typeof bar); // "undefined"\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"5-\u4f5c\u7528\u57df\u89e3\u6790\u8fc7\u7a0b",children:"5. \u4f5c\u7528\u57df\u89e3\u6790\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u89e3\u6790\u7b97\u6cd5",children:"\u53d8\u91cf\u89e3\u6790\u7b97\u6cd5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// src/ast/scopes.cc\ntemplate <ScopeLookupMode mode>\nVariable* Scope::Lookup(VariableProxy* proxy, Scope* scope,\n                       Scope* outer_scope_end, Scope* cache_scope) {\n  Scope* lookup_scope = scope;\n  \n  while (lookup_scope != outer_scope_end) {\n    // \u5728\u5f53\u524d\u4f5c\u7528\u57df\u4e2d\u67e5\u627e\n    Variable* var = lookup_scope->LookupLocal(proxy->raw_name());\n    if (var != nullptr) {\n      return var;\n    }\n    \n    // \u79fb\u52a8\u5230\u5916\u5c42\u4f5c\u7528\u57df\n    lookup_scope = lookup_scope->outer_scope();\n  }\n  \n  return nullptr; // \u672a\u627e\u5230\u53d8\u91cf\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u53d8\u91cf\u7ed1\u5b9a\u8fc7\u7a0b",children:"\u53d8\u91cf\u7ed1\u5b9a\u8fc7\u7a0b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"void Parser::ResolveVariable(VariableProxy* proxy) {\n  Variable* var = scope()->LookupLocal(proxy->raw_name());\n  \n  if (var == nullptr) {\n    // \u5728\u4f5c\u7528\u57df\u94fe\u4e2d\u67e5\u627e\n    var = Scope::Lookup(proxy, scope(), nullptr);\n  }\n  \n  if (var != nullptr) {\n    proxy->BindTo(var);\n  } else {\n    // \u521b\u5efa\u5168\u5c40\u53d8\u91cf\u6216\u62a5\u9519\n    HandleUnresolvedVariable(proxy);\n  }\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"6-\u7279\u6b8a\u4f5c\u7528\u57df\u60c5\u51b5",children:"6. \u7279\u6b8a\u4f5c\u7528\u57df\u60c5\u51b5"}),"\n",(0,r.jsx)(e.h3,{id:"with\u8bed\u53e5\u7684\u52a8\u6001\u4f5c\u7528\u57df",children:"with\u8bed\u53e5\u7684\u52a8\u6001\u4f5c\u7528\u57df"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function withExample() {\n  let x = 1;\n  let obj = { x: 2 };\n  \n  with (obj) {\n    console.log(x); // 2 - \u52a8\u6001\u67e5\u627eobj.x\n  }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5904\u7406with\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class WithScope : public Scope {\n  // with\u8bed\u53e5\u521b\u5efa\u52a8\u6001\u4f5c\u7528\u57df\n  // \u53d8\u91cf\u67e5\u627e\u9700\u8981\u5728\u8fd0\u884c\u65f6\u8fdb\u884c\n  bool is_with_scope() const override { return true; }\n};\n\n// with\u8bed\u53e5\u4e2d\u7684\u53d8\u91cf\u8bbf\u95ee\u9700\u8981\u8fd0\u884c\u65f6\u67e5\u627e\nvoid BytecodeGenerator::VisitWithStatement(WithStatement* stmt) {\n  // \u521b\u5efawith\u4e0a\u4e0b\u6587\n  builder()->CreateWithContext(stmt->expression());\n  // \u5728with\u4e0a\u4e0b\u6587\u4e2d\u6267\u884c\u8bed\u53e5\n  Visit(stmt->statement());\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"eval\u7684\u4f5c\u7528\u57df\u5f71\u54cd",children:"eval\u7684\u4f5c\u7528\u57df\u5f71\u54cd"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function evalExample() {\n  let x = 1;\n  \n  function inner() {\n    eval("var y = 2;"); // \u52a8\u6001\u521b\u5efa\u53d8\u91cf\n    console.log(y);     // 2\n  }\n  \n  inner();\n  // console.log(y);    // ReferenceError: y is not defined\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"V8\u5904\u7406eval\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"void DeclarationScope::RecordDeclarationScopeEvalCall() {\n  calls_eval_ = true;\n  // eval\u8c03\u7528\u4f1a\u5f71\u54cd\u4f5c\u7528\u57df\u7684\u4f18\u5316\n  sloppy_eval_can_extend_vars_ = true;\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"7-\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801\u8868\u793a",children:"7. \u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801\u8868\u793a"}),"\n",(0,r.jsx)(e.h3,{id:"\u4e0a\u4e0b\u6587\u521b\u5efa\u5b57\u8282\u7801",children:"\u4e0a\u4e0b\u6587\u521b\u5efa\u5b57\u8282\u7801"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function scopeExample() {\n  let x = 1;\n  \n  function inner() {\n    return x;\n  }\n  \n  return inner;\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u7684\u5b57\u8282\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"// scopeExample\u51fd\u6570\nCreateFunctionContext [1]    // \u521b\u5efa\u51fd\u6570\u4e0a\u4e0b\u6587\uff0c1\u4e2a\u69fd\u4f4d\nPushContext r0              // \u4fdd\u5b58\u5f53\u524d\u4e0a\u4e0b\u6587\nLdaSmi [1]                  // \u52a0\u8f7d\u5e38\u91cf1\nStaCurrentContextSlot [0]   // \u5b58\u50a8x\u5230\u4e0a\u4e0b\u6587\u69fd\u4f4d0\nCreateClosure [0], [1]      // \u521b\u5efainner\u95ed\u5305\nPopContext r0               // \u6062\u590d\u4e0a\u4e0b\u6587\nReturn                      // \u8fd4\u56de\u95ed\u5305\n\n// inner\u51fd\u6570\nLdaCurrentContextSlot [0]   // \u4ece\u4e0a\u4e0b\u6587\u52a0\u8f7dx\nReturn                      // \u8fd4\u56dex\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u5757\u7ea7\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801",children:"\u5757\u7ea7\u4f5c\u7528\u57df\u7684\u5b57\u8282\u7801"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"function blockScopeExample() {\n  let x = 1;\n  \n  {\n    let y = 2;\n    console.log(x + y);\n  }\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u751f\u6210\u7684\u5b57\u8282\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"LdaSmi [1]                  // \u52a0\u8f7d1\nStar r0                     // \u5b58\u50a8\u5230\u5bc4\u5b58\u5668r0 (x)\n\nCreateBlockContext [0]      // \u521b\u5efa\u5757\u7ea7\u4e0a\u4e0b\u6587\nPushContext r1              // \u4fdd\u5b58\u5f53\u524d\u4e0a\u4e0b\u6587\nLdaSmi [2]                  // \u52a0\u8f7d2\nStaCurrentContextSlot [0]   // \u5b58\u50a8y\u5230\u4e0a\u4e0b\u6587\u69fd\u4f4d0\n\n// console.log(x + y)\nLdar r0                     // \u52a0\u8f7dx\nLdaCurrentContextSlot [0]   // \u52a0\u8f7dy\nAdd r0, [1]                 // x + y\n// ... console.log\u8c03\u7528\n\nPopContext r1               // \u6062\u590d\u4e0a\u4e0b\u6587\n"})}),"\n",(0,r.jsx)(e.h2,{id:"8-\u6682\u65f6\u6027\u6b7b\u533atdz\u5b9e\u73b0",children:"8. \u6682\u65f6\u6027\u6b7b\u533a(TDZ)\u5b9e\u73b0"}),"\n",(0,r.jsx)(e.h3,{id:"tdz\u7684\u68c0\u67e5\u673a\u5236",children:"TDZ\u7684\u68c0\u67e5\u673a\u5236"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class Variable {\n  // \u521d\u59cb\u5316\u72b6\u6001\n  enum InitializationFlag {\n    kCreatedInitialized,    // \u5df2\u521d\u59cb\u5316\uff08var\uff09\n    kNeedsInitialization    // \u9700\u8981\u521d\u59cb\u5316\uff08let/const\uff09\n  };\n  \n  int initializer_position_; // \u521d\u59cb\u5316\u4f4d\u7f6e\n  \n  bool binding_needs_init() const {\n    return initialization_flag() == kNeedsInitialization;\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"tdz\u68c0\u67e5\u7684\u5b57\u8282\u7801\u751f\u6210",children:"TDZ\u68c0\u67e5\u7684\u5b57\u8282\u7801\u751f\u6210"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"void BytecodeGenerator::VisitVariableProxy(VariableProxy* proxy) {\n  Variable* variable = proxy->var();\n  \n  if (variable->binding_needs_init()) {\n    // \u751f\u6210TDZ\u68c0\u67e5\n    builder()->ThrowReferenceErrorIfHole(variable->raw_name());\n  }\n  \n  // \u52a0\u8f7d\u53d8\u91cf\u503c\n  BuildVariableLoad(variable);\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"tdz\u793a\u4f8b",children:"TDZ\u793a\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function tdzExample() {\n  console.log(typeof x); // "undefined" - var\u63d0\u5347\n  console.log(typeof y); // ReferenceError - let\u7684TDZ\n  \n  var x = 1;\n  let y = 2;\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"9-\u4f5c\u7528\u57df\u4f18\u5316",children:"9. \u4f5c\u7528\u57df\u4f18\u5316"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f5c\u7528\u57df\u5206\u6790\u4f18\u5316",children:"\u4f5c\u7528\u57df\u5206\u6790\u4f18\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"class Scope {\n  // \u68c0\u67e5\u4f5c\u7528\u57df\u662f\u5426\u53ef\u4ee5\u88ab\u4f18\u5316\n  bool AllowsLazyParsingWithoutUnresolvedVariables(const Scope* outer) const;\n  \n  // \u68c0\u67e5\u662f\u5426\u9700\u8981\u4e0a\u4e0b\u6587\u5bf9\u8c61\n  bool NeedsContext() const {\n    return num_heap_slots() > 0;\n  }\n  \n  // \u5f3a\u5236\u53d8\u91cf\u5206\u914d\u5230\u4e0a\u4e0b\u6587\n  void ForceContextAllocationForParameters() {\n    force_context_allocation_for_parameters_ = true;\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u7f16\u8bd1\u5668\u4f18\u5316",children:"\u7f16\u8bd1\u5668\u4f18\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"// TurboFan\u4e2d\u7684\u4f5c\u7528\u57df\u4f18\u5316\nclass JSContextSpecialization : public AdvancedReducer {\n  // \u5c06\u4e0a\u4e0b\u6587\u8bbf\u95ee\u4f18\u5316\u4e3a\u76f4\u63a5\u5185\u5b58\u8bbf\u95ee\n  Reduction ReduceJSLoadContext(Node* node) {\n    // \u5982\u679c\u4e0a\u4e0b\u6587\u662f\u5e38\u91cf\uff0c\u76f4\u63a5\u66ff\u6362\u4e3a\u5e38\u91cf\u503c\n    if (context_is_constant) {\n      return Replace(constant_value);\n    }\n  }\n};\n"})}),"\n",(0,r.jsx)(e.h2,{id:"10-\u8c03\u8bd5\u4f5c\u7528\u57df",children:"10. \u8c03\u8bd5\u4f5c\u7528\u57df"}),"\n",(0,r.jsx)(e.h3,{id:"\u8c03\u8bd5\u5de5\u5177",children:"\u8c03\u8bd5\u5de5\u5177"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u67e5\u770b\u4f5c\u7528\u57df\u4fe1\u606f\nd8 --print-scopes script.js\n\n# \u67e5\u770b\u4f5c\u7528\u57df\u89e3\u6790\u8fc7\u7a0b\nd8 --trace-scope-resolution script.js\n\n# \u67e5\u770b\u4e0a\u4e0b\u6587\u521b\u5efa\nd8 --trace-contexts script.js\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u4f5c\u7528\u57df\u53ef\u89c6\u5316",children:"\u4f5c\u7528\u57df\u53ef\u89c6\u5316"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u4f7f\u7528\u8c03\u8bd5API\u67e5\u770b\u4f5c\u7528\u57df\nfunction debugScope() {\n  let x = 1;\n  \n  function inner() {\n    let y = 2;\n    debugger; // \u5728\u6b64\u5904\u53ef\u4ee5\u67e5\u770b\u4f5c\u7528\u57df\u94fe\n    return x + y;\n  }\n  \n  return inner;\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"11-\u5e38\u89c1\u4f5c\u7528\u57df\u9677\u9631",children:"11. \u5e38\u89c1\u4f5c\u7528\u57df\u9677\u9631"}),"\n",(0,r.jsx)(e.h3,{id:"\u5faa\u73af\u4e2d\u7684\u4f5c\u7528\u57df\u95ee\u9898",children:"\u5faa\u73af\u4e2d\u7684\u4f5c\u7528\u57df\u95ee\u9898"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:"// \u95ee\u9898\u4ee3\u7801\nfunction loopProblem() {\n  const funcs = [];\n  \n  for (var i = 0; i < 3; i++) {\n    funcs.push(function() {\n      return i; // \u6240\u6709\u51fd\u6570\u90fd\u8fd4\u56de3\n    });\n  }\n  \n  return funcs;\n}\n\n// \u89e3\u51b3\u65b9\u68481\uff1a\u4f7f\u7528let\nfunction loopSolution1() {\n  const funcs = [];\n  \n  for (let i = 0; i < 3; i++) { // let\u521b\u5efa\u5757\u7ea7\u4f5c\u7528\u57df\n    funcs.push(function() {\n      return i; // \u6bcf\u4e2a\u51fd\u6570\u6355\u83b7\u4e0d\u540c\u7684i\n    });\n  }\n  \n  return funcs;\n}\n\n// \u89e3\u51b3\u65b9\u68482\uff1a\u4f7f\u7528IIFE\nfunction loopSolution2() {\n  const funcs = [];\n  \n  for (var i = 0; i < 3; i++) {\n    funcs.push((function(j) {\n      return function() {\n        return j; // \u6355\u83b7\u53c2\u6570j\n      };\n    })(i));\n  }\n  \n  return funcs;\n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u610f\u5916\u7684\u5168\u5c40\u53d8\u91cf",children:"\u610f\u5916\u7684\u5168\u5c40\u53d8\u91cf"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'function accidentalGlobal() {\n  // \u5fd8\u8bb0\u58f0\u660e\u53d8\u91cf\uff0c\u521b\u5efa\u4e86\u5168\u5c40\u53d8\u91cf\n  x = 1; // \u7b49\u540c\u4e8e window.x = 1\n  \n  function inner() {\n    y = 2; // \u4e5f\u521b\u5efa\u4e86\u5168\u5c40\u53d8\u91cf\n  }\n  \n  inner();\n}\n\n// \u4e25\u683c\u6a21\u5f0f\u4e0b\u4f1a\u62a5\u9519\nfunction strictMode() {\n  "use strict";\n  x = 1; // ReferenceError: x is not defined\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"12-\u6700\u4f73\u5b9e\u8df5",children:"12. \u6700\u4f73\u5b9e\u8df5"}),"\n",(0,r.jsx)(e.h3,{id:"\u4f5c\u7528\u57df\u7ba1\u7406\u5efa\u8bae",children:"\u4f5c\u7528\u57df\u7ba1\u7406\u5efa\u8bae"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-javascript",children:'// 1. \u4f18\u5148\u4f7f\u7528let/const\nfunction goodPractice() {\n  const config = { api: \'https://api.example.com\' }; // \u4e0d\u53d8\u7684\u7528const\n  let counter = 0; // \u53ef\u53d8\u7684\u7528let\n  \n  // \u907f\u514d\u4f7f\u7528var\n  // var oldStyle = "avoid this";\n}\n\n// 2. \u6700\u5c0f\u5316\u4f5c\u7528\u57df\nfunction minimizeScope() {\n  // \u5c06\u53d8\u91cf\u58f0\u660e\u5728\u6700\u5c0f\u7684\u5fc5\u8981\u4f5c\u7528\u57df\u5185\n  if (condition) {\n    const tempData = processData(); // \u53ea\u5728\u9700\u8981\u65f6\u58f0\u660e\n    return tempData.result;\n  }\n}\n\n// 3. \u907f\u514d\u6c61\u67d3\u5168\u5c40\u4f5c\u7528\u57df\n(function() {\n  // \u4f7f\u7528IIFE\u907f\u514d\u5168\u5c40\u6c61\u67d3\n  const privateVar = "not global";\n  \n  // \u53ea\u66b4\u9732\u5fc5\u8981\u7684\u63a5\u53e3\n  window.MyLibrary = {\n    publicMethod: function() {\n      return privateVar;\n    }\n  };\n})();\n'})}),"\n",(0,r.jsx)(e.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsx)(e.p,{children:"V8\u4e2d\u7684\u4f5c\u7528\u57df\u7cfb\u7edf\u5b9e\u73b0\u4e86JavaScript\u7684\u8bcd\u6cd5\u4f5c\u7528\u57df\u89c4\u5219\uff1a"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u9759\u6001\u786e\u5b9a"}),": \u4f5c\u7528\u57df\u5728\u7f16\u8bd1\u65f6\u786e\u5b9a\uff0c\u4e0d\u662f\u8fd0\u884c\u65f6"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u94fe\u5f0f\u67e5\u627e"}),": \u53d8\u91cf\u67e5\u627e\u6cbf\u7740\u4f5c\u7528\u57df\u94fe\u8fdb\u884c"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u7c7b\u578b\u533a\u5206"}),": \u4e0d\u540c\u58f0\u660e\u65b9\u5f0f\u6709\u4e0d\u540c\u7684\u4f5c\u7528\u57df\u884c\u4e3a"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u4f18\u5316\u652f\u6301"}),": \u7f16\u8bd1\u5668\u53ef\u4ee5\u4f18\u5316\u4f5c\u7528\u57df\u8bbf\u95ee"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"\u8c03\u8bd5\u53cb\u597d"}),": \u63d0\u4f9b\u4e30\u5bcc\u7684\u8c03\u8bd5\u4fe1\u606f"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"\u7406\u89e3\u8fd9\u4e9b\u673a\u5236\u6709\u52a9\u4e8e\u7f16\u5199\u66f4\u9ad8\u6548\u3001\u66f4\u53ef\u7ef4\u62a4\u7684JavaScript\u4ee3\u7801\u3002"})]})}function p(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},8453:(n,e,l)=>{l.d(e,{R:()=>c,x:()=>o});var i=l(6540);const r={},a=i.createContext(r);function c(n){const e=i.useContext(a);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),i.createElement(a.Provider,{value:e},n.children)}}}]);